<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Durak - Gra Karciana</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
        }

        /* Ekran logowania */
        #loginScreen {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        #loginScreen h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        #loginScreen input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.9);
        }

        #loginScreen button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        #loginScreen button:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Lobby */
        #lobby {
            display: none;
        }

        .lobby-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lobby-header h2 {
            font-size: 1.8em;
        }

        .lobby-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .lobby-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
        }

        .lobby-section h3 {
            font-size: 1.3em;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        #roomsList, #invitationsList {
            max-height: 400px;
            overflow-y: auto;
        }

        .room-item, .invitation-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .room-item:hover, .invitation-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }

        .room-info {
            flex: 1;
        }

        .room-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .room-players {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #757575;
            color: white;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .create-room-form {
            margin-bottom: 20px;
        }

        .create-room-form input {
            width: calc(100% - 120px);
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            background: rgba(255, 255, 255, 0.9);
            margin-right: 10px;
        }

        /* Ekran gry */
        #gameScreen {
            display: none;
        }

        .game-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .trump-card {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .game-area {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            min-height: 500px;
        }

        /* Obszar sto≈Çu */
        #table {
            min-height: 200px;
            background: rgba(0, 100, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        /* Karty */
        .card {
            width: 80px;
            height: 120px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-weight: bold;
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        .card.red {
            color: #d32f2f;
        }

        .card.black {
            color: #000;
        }

        .card-top {
            font-size: 1.2em;
            text-align: left;
        }

        .card-center {
            font-size: 2em;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-bottom {
            font-size: 1.2em;
            text-align: right;
            transform: rotate(180deg);
        }

        .card.selected {
            border: 3px solid #FFD700;
            transform: translateY(-15px);
        }

        /* Rƒôka gracza */
        .player-hand {
            margin-top: 30px;
        }

        .player-hand h3 {
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
        }

        .hand {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            min-height: 140px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        /* Przyciski akcji */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .action-buttons button {
            padding: 12px 30px;
            font-size: 1.1em;
        }

        /* Informacje o przeciwniku */
        .opponent-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .opponent-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .opponent-cards {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Status gry */
        .game-status {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: bold;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Animacje */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .room-item, .invitation-item {
            animation: fadeIn 0.3s ease-out;
        }

        /* Responsywno≈õƒá */
        @media (max-width: 768px) {
            .lobby-content {
                grid-template-columns: 1fr;
            }

            .card {
                width: 60px;
                height: 90px;
                padding: 5px;
            }

            .card-top, .card-bottom {
                font-size: 0.9em;
            }

            .card-center {
                font-size: 1.5em;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Para kart na stole */
        .card-pair {
            display: flex;
            flex-direction: column;
            gap: 5px;
            position: relative;
        }

        .card-pair .card:last-child {
            margin-left: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ekran logowania -->
        <div id="loginScreen">
            <h1>üÉè Durak</h1>
            <input type="text" id="usernameInput" placeholder="Wpisz swojƒÖ nazwƒô" maxlength="20">
            <button onclick="login()">Rozpocznij grƒô</button>
        </div>

        <!-- Lobby -->
        <div id="lobby">
            <div class="lobby-header">
                <h2>Lobby - Witaj, <span id="currentUsername"></span>!</h2>
                <button class="btn btn-secondary" onclick="logout()">Wyloguj</button>
            </div>

            <div class="lobby-content">
                <!-- Lista pokoi -->
                <div class="lobby-section">
                    <h3>Dostƒôpne pokoje</h3>
                    <div class="create-room-form">
                        <input type="text" id="roomNameInput" placeholder="Nazwa pokoju" maxlength="30">
                        <button class="btn btn-success" onclick="createRoom()">Utw√≥rz</button>
                    </div>
                    <div id="roomsList"></div>
                </div>

                <!-- Lista zaprosze≈Ñ -->
                <div class="lobby-section">
                    <h3>Zaproszenia</h3>
                    <div id="invitationsList"></div>
                </div>
            </div>
        </div>

        <!-- Ekran gry -->
        <div id="gameScreen">
            <div class="game-header">
                <div class="game-info">
                    <div class="info-item">
                        <div class="info-label">Pok√≥j</div>
                        <div class="info-value" id="roomNameDisplay"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Karty w talii</div>
                        <div class="info-value" id="deckCount">36</div>
                    </div>
                    <div class="info-item trump-card">
                        <div class="info-label">Atut:</div>
                        <div class="info-value" id="trumpDisplay">‚ô†Ô∏è</div>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="leaveGame()">Opu≈õƒá grƒô</button>
            </div>

            <div class="game-area">
                <!-- Status gry -->
                <div class="game-status" id="gameStatus">Oczekiwanie na rozpoczƒôcie gry...</div>

                <!-- Informacje o przeciwniku -->
                <div class="opponent-info">
                    <div class="opponent-name" id="opponentName">Przeciwnik</div>
                    <div class="opponent-cards">Karty: <span id="opponentCardCount">6</span></div>
                </div>

                <!-- St√≥≈Ç (obszar ataku/obrony) -->
                <div id="table"></div>

                <!-- Rƒôka gracza -->
                <div class="player-hand">
                    <h3>Twoje karty</h3>
                    <div class="hand" id="playerHand"></div>
                </div>

                <!-- Przyciski akcji -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="attackBtn" onclick="attack()">Atakuj</button>
                    <button class="btn btn-success" id="defendBtn" onclick="defend()">Bro≈Ñ</button>
                    <button class="btn btn-danger" id="takeBtn" onclick="takeCards()">We≈∫ karty</button>
                    <button class="btn btn-secondary" id="passBtn" onclick="pass()">Pas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push, remove, update, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDMau-CR81wWPvQPCii85JEzorLabre6EM",
            authDomain: "durak-c7c64.firebaseapp.com",
            databaseURL: "https://durak-c7c64-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "durak-c7c64",
            storageBucket: "durak-c7c64.firebasestorage.app",
            messagingSenderId: "846594020561",
            appId: "1:846594020561:web:4f5e6c0bc9b6e8e4b7ec3b"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Globalne zmienne
        window.currentUser = null;
        window.currentRoom = null;
        window.selectedCard = null;

        // Funkcja logowania
        window.login = function() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('Wpisz swojƒÖ nazwƒô!');
                return;
            }

            window.currentUser = username;
            document.getElementById('currentUsername').textContent = username;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('lobby').style.display = 'block';

            // Nas≈Çuchiwanie na pokoje
            const roomsRef = ref(database, 'rooms');
            onValue(roomsRef, (snapshot) => {
                displayRooms(snapshot.val());
            });

            // Nas≈Çuchiwanie na zaproszenia
            const invitationsRef = ref(database, `invitations/${username}`);
            onValue(invitationsRef, (snapshot) => {
                displayInvitations(snapshot.val());
            });
        };

        // Wylogowanie
        window.logout = function() {
            window.currentUser = null;
            window.currentRoom = null;
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('usernameInput').value = '';
        };

        // Tworzenie pokoju
        window.createRoom = function() {
            const roomName = document.getElementById('roomNameInput').value.trim();
            if (!roomName) {
                alert('Wpisz nazwƒô pokoju!');
                return;
            }

            const roomId = 'room_' + Date.now();
            const roomRef = ref(database, `rooms/${roomId}`);

            set(roomRef, {
                name: roomName,
                host: window.currentUser,
                players: {
                    [window.currentUser]: {
                        name: window.currentUser,
                        ready: false,
                        hand: []
                    }
                },
                status: 'waiting',
                createdAt: Date.now()
            }).then(() => {
                document.getElementById('roomNameInput').value = '';
                alert('Pok√≥j utworzony! Zapro≈õ gracza.');
            });
        };

        // Wy≈õwietlanie pokoi
        function displayRooms(rooms) {
            const roomsList = document.getElementById('roomsList');
            roomsList.innerHTML = '';

            if (!rooms) {
                roomsList.innerHTML = '<p style="text-align: center; opacity: 0.6;">Brak dostƒôpnych pokoi</p>';
                return;
            }

            Object.entries(rooms).forEach(([roomId, room]) => {
                const playerCount = room.players ? Object.keys(room.players).length : 0;
                const isUserInRoom = room.players && room.players[window.currentUser];

                const roomDiv = document.createElement('div');
                roomDiv.className = 'room-item';
                roomDiv.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">${room.name}</div>
                        <div class="room-players">Gracze: ${playerCount}/2 | Host: ${room.host}</div>
                    </div>
                `;

                if (isUserInRoom) {
                    const enterBtn = document.createElement('button');
                    enterBtn.className = 'btn btn-success';
                    enterBtn.textContent = 'Wejd≈∫';
                    enterBtn.onclick = () => enterRoom(roomId);
                    roomDiv.appendChild(enterBtn);
                } else if (playerCount < 2) {
                    const inviteBtn = document.createElement('button');
                    inviteBtn.className = 'btn btn-primary';
                    inviteBtn.textContent = 'Zapro≈õ mnie';
                    inviteBtn.onclick = () => requestInvite(roomId, room.host);
                    roomDiv.appendChild(inviteBtn);
                }

                roomsList.appendChild(roomDiv);
            });
        }

        // Pro≈õba o zaproszenie
        window.requestInvite = function(roomId, hostName) {
            const inviteRef = ref(database, `invitations/${hostName}/${roomId}_${window.currentUser}`);
            set(inviteRef, {
                roomId: roomId,
                from: window.currentUser,
                timestamp: Date.now()
            }).then(() => {
                alert('Pro≈õba o zaproszenie wys≈Çana!');
            });
        };

        // Wy≈õwietlanie zaprosze≈Ñ
        function displayInvitations(invitations) {
            const invitationsList = document.getElementById('invitationsList');
            invitationsList.innerHTML = '';

            if (!invitations) {
                invitationsList.innerHTML = '<p style="text-align: center; opacity: 0.6;">Brak zaprosze≈Ñ</p>';
                return;
            }

            Object.entries(invitations).forEach(([inviteId, invite]) => {
                const inviteDiv = document.createElement('div');
                inviteDiv.className = 'invitation-item';
                inviteDiv.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">Zaproszenie od ${invite.from}</div>
                    </div>
                `;

                const acceptBtn = document.createElement('button');
                acceptBtn.className = 'btn btn-success';
                acceptBtn.textContent = 'Akceptuj';
                acceptBtn.onclick = () => acceptInvite(invite.roomId, invite.from, inviteId);
                inviteDiv.appendChild(acceptBtn);

                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'btn btn-danger';
                rejectBtn.textContent = 'Odrzuƒá';
                rejectBtn.onclick = () => rejectInvite(inviteId);
                inviteDiv.appendChild(rejectBtn);

                invitationsList.appendChild(inviteDiv);
            });
        }

        // Akceptowanie zaproszenia
        window.acceptInvite = function(roomId, from, inviteId) {
            const playerRef = ref(database, `rooms/${roomId}/players/${window.currentUser}`);
            set(playerRef, {
                name: window.currentUser,
                ready: false,
                hand: []
            }).then(() => {
                // Usu≈Ñ zaproszenie
                const inviteRef = ref(database, `invitations/${window.currentUser}/${inviteId}`);
                remove(inviteRef);
                
                // Wejd≈∫ do pokoju
                enterRoom(roomId);
            });
        };

        // Odrzucanie zaproszenia
        window.rejectInvite = function(inviteId) {
            const inviteRef = ref(database, `invitations/${window.currentUser}/${inviteId}`);
            remove(inviteRef);
        };

        // Wej≈õcie do pokoju
        window.enterRoom = function(roomId) {
            window.currentRoom = roomId;
            
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';

            // Nas≈Çuchiwanie na zmiany w pokoju
            const roomRef = ref(database, `rooms/${roomId}`);
            onValue(roomRef, (snapshot) => {
                const room = snapshot.val();
                if (room) {
                    updateGameScreen(room);
                    
                    // Sprawd≈∫ czy gra siƒô rozpoczƒô≈Ça
                    if (room.status === 'playing' && !room.gameStarted) {
                        startGame(roomId);
                    }
                } else {
                    // Pok√≥j zosta≈Ç usuniƒôty
                    leaveGame();
                }
            });

            // Wy≈õwietl nazwƒô pokoju
            get(roomRef).then((snapshot) => {
                const room = snapshot.val();
                if (room) {
                    document.getElementById('roomNameDisplay').textContent = room.name;
                }
            });
        };

        // Aktualizacja ekranu gry
        function updateGameScreen(room) {
            const players = room.players ? Object.keys(room.players) : [];
            const playerCount = players.length;

            if (playerCount === 2 && room.status === 'waiting') {
                // Automatyczne rozpoczƒôcie gry gdy jest 2 graczy
                const roomRef = ref(database, `rooms/${window.currentRoom}`);
                update(roomRef, { status: 'playing' });
            }

            if (room.status === 'playing') {
                document.getElementById('gameStatus').textContent = 'Gra w toku...';
                renderGame(room);
            } else {
                document.getElementById('gameStatus').textContent = `Oczekiwanie na graczy (${playerCount}/2)...`;
            }

            // Zaktualizuj informacje o przeciwniku
            const opponent = players.find(p => p !== window.currentUser);
            if (opponent && room.players[opponent]) {
                document.getElementById('opponentName').textContent = opponent;
                const opponentHandSize = room.players[opponent].hand ? room.players[opponent].hand.length : 0;
                document.getElementById('opponentCardCount').textContent = opponentHandSize;
            }
        }

        // Opuszczanie gry
        window.leaveGame = function() {
            if (window.currentRoom) {
                const playerRef = ref(database, `rooms/${window.currentRoom}/players/${window.currentUser}`);
                remove(playerRef).then(() => {
                    // Sprawd≈∫ czy pok√≥j jest pusty
                    const roomRef = ref(database, `rooms/${window.currentRoom}`);
                    get(roomRef).then((snapshot) => {
                        const room = snapshot.val();
                        if (room && room.players) {
                            const remainingPlayers = Object.keys(room.players).length;
                            if (remainingPlayers === 0) {
                                // Usu≈Ñ pusty pok√≥j
                                remove(roomRef);
                            }
                        }
                    });
                });

                window.currentRoom = null;
            }

            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('lobby').style.display = 'block';
        };

        // ===== LOGIKA GRY =====

        // Tworzenie talii (36 kart)
        function createDeck() {
            const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
            const values = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const deck = [];

            for (let suit of suits) {
                for (let value of values) {
                    deck.push({
                        suit: suit,
                        value: value,
                        color: (suit === '‚ô•' || suit === '‚ô¶') ? 'red' : 'black'
                    });
                }
            }

            return deck;
        }

        // Tasowanie talii (Fisher-Yates)
        function shuffleDeck(deck) {
            const shuffled = [...deck];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Rozpoczƒôcie gry
        window.startGame = function(roomId) {
            const roomRef = ref(database, `rooms/${roomId}`);
            
            get(roomRef).then((snapshot) => {
                const room = snapshot.val();
                if (!room || room.gameStarted) return;

                // Stw√≥rz i przetasuj taliƒô
                let deck = createDeck();
                deck = shuffleDeck(deck);

                // Wylosuj atut (ostatnia karta)
                const trumpCard = deck[deck.length - 1];

                // Rozdaj po 6 kart ka≈ºdemu graczowi
                const players = Object.keys(room.players);
                const hands = {};

                players.forEach(player => {
                    hands[player] = [];
                    for (let i = 0; i < 6; i++) {
                        if (deck.length > 0) {
                            hands[player].push(deck.shift());
                        }
                    }
                });

                // Zapisz stan gry
                const gameState = {
                    deck: deck,
                    trump: trumpCard,
                    table: [],
                    currentAttacker: players[0],
                    currentDefender: players[1],
                    gameStarted: true,
                    turnPhase: 'attack' // attack, defend, pass
                };

                // Aktualizuj pok√≥j
                const updates = {
                    ...gameState
                };

                // Aktualizuj rƒôce graczy
                players.forEach(player => {
                    updates[`players/${player}/hand`] = hands[player];
                });

                update(roomRef, updates);
            });
        };

        // Renderowanie gry
        window.renderGame = function(room) {
            if (!room.gameStarted) return;

            // Zaktualizuj licznik talii
            const deckCount = room.deck ? room.deck.length : 0;
            document.getElementById('deckCount').textContent = deckCount;

            // Zaktualizuj atut
            if (room.trump) {
                document.getElementById('trumpDisplay').textContent = room.trump.suit + ' ' + room.trump.value;
            }

            // Wyrenderuj karty na stole
            renderTable(room.table || []);

            // Wyrenderuj rƒôkƒô gracza
            const playerHand = room.players[window.currentUser]?.hand || [];
            renderPlayerHand(playerHand);

            // Zaktualizuj status gry
            updateGameStatus(room);

            // Zaktualizuj dostƒôpno≈õƒá przycisk√≥w
            updateButtons(room);
        };

        // Renderowanie sto≈Çu
        function renderTable(table) {
            const tableDiv = document.getElementById('table');
            tableDiv.innerHTML = '';

            if (table.length === 0) {
                tableDiv.innerHTML = '<p style="color: rgba(255,255,255,0.5);">St√≥≈Ç jest pusty</p>';
                return;
            }

            table.forEach((pair, index) => {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'card-pair';

                // Karta atakujƒÖcego
                if (pair.attack) {
                    const attackCard = createCardElement(pair.attack);
                    pairDiv.appendChild(attackCard);
                }

                // Karta broniƒÖcego
                if (pair.defend) {
                    const defendCard = createCardElement(pair.defend);
                    pairDiv.appendChild(defendCard);
                }

                tableDiv.appendChild(pairDiv);
            });
        }

        // Renderowanie rƒôki gracza
        function renderPlayerHand(hand) {
            const handDiv = document.getElementById('playerHand');
            handDiv.innerHTML = '';

            if (hand.length === 0) {
                handDiv.innerHTML = '<p style="color: rgba(255,255,255,0.5);">Brak kart</p>';
                return;
            }

            hand.forEach((card, index) => {
                const cardElement = createCardElement(card);
                cardElement.onclick = () => selectCard(index);
                handDiv.appendChild(cardElement);
            });
        }

        // Tworzenie elementu karty
        function createCardElement(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = `card ${card.color}`;
            cardDiv.innerHTML = `
                <div class="card-top">${card.value}${card.suit}</div>
                <div class="card-center">${card.suit}</div>
                <div class="card-bottom">${card.value}${card.suit}</div>
            `;
            return cardDiv;
        }

        // Wyb√≥r karty
        window.selectCard = function(cardIndex) {
            // Usu≈Ñ poprzednie zaznaczenie
            document.querySelectorAll('.card.selected').forEach(card => {
                card.classList.remove('selected');
            });

            // Zaznacz nowƒÖ kartƒô
            window.selectedCard = cardIndex;
            const cards = document.querySelectorAll('#playerHand .card');
            if (cards[cardIndex]) {
                cards[cardIndex].classList.add('selected');
            }
        };

        // Aktualizacja statusu gry
        function updateGameStatus(room) {
            let status = '';
            const isAttacker = room.currentAttacker === window.currentUser;

            if (room.turnPhase === 'attack') {
                status = isAttacker ? 'Twoja kolej - ATAKUJ!' : `${room.currentAttacker} atakuje...`;
            } else if (room.turnPhase === 'defend') {
                status = isAttacker ? `${room.currentDefender} broni siƒô...` : 'Twoja kolej - BRO≈É SIƒò!';
            }

            document.getElementById('gameStatus').textContent = status;
        }

        // Aktualizacja przycisk√≥w
        function updateButtons(room) {
            const isAttacker = room.currentAttacker === window.currentUser;
            const isDefender = room.currentDefender === window.currentUser;

            document.getElementById('attackBtn').disabled = !isAttacker || room.turnPhase !== 'attack';
            document.getElementById('defendBtn').disabled = !isDefender || room.turnPhase !== 'defend';
            document.getElementById('takeBtn').disabled = !isDefender || room.turnPhase !== 'defend';
            document.getElementById('passBtn').disabled = !isAttacker || room.turnPhase !== 'attack';
        }

        // Atak
        window.attack = function() {
            if (window.selectedCard === null) {
                alert('Wybierz kartƒô!');
                return;
            }

            const roomRef = ref(database, `rooms/${window.currentRoom}`);
            get(roomRef).then((snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const playerHand = room.players[window.currentUser].hand;
                const card = playerHand[window.selectedCard];

                // Dodaj kartƒô do sto≈Çu
                const newTable = room.table || [];
                newTable.push({
                    attack: card,
                    defend: null
                });

                // Usu≈Ñ kartƒô z rƒôki
                playerHand.splice(window.selectedCard, 1);

                // Aktualizuj pok√≥j
                update(roomRef, {
                    table: newTable,
                    [`players/${window.currentUser}/hand`]: playerHand,
                    turnPhase: 'defend'
                });

                window.selectedCard = null;
            });
        };

        // Obrona
        window.defend = function() {
            if (window.selectedCard === null) {
                alert('Wybierz kartƒô!');
                return;
            }

            const roomRef = ref(database, `rooms/${window.currentRoom}`);
            get(roomRef).then((snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const playerHand = room.players[window.currentUser].hand;
                const defendCard = playerHand[window.selectedCard];
                const table = room.table || [];

                // Znajd≈∫ pierwszƒÖ niebronionƒÖ kartƒô
                let undefendedIndex = -1;
                for (let i = 0; i < table.length; i++) {
                    if (!table[i].defend) {
                        undefendedIndex = i;
                        break;
                    }
                }

                if (undefendedIndex === -1) {
                    alert('Wszystkie karty sƒÖ ju≈º obronione!');
                    return;
                }

                // Dodaj kartƒô obronnƒÖ
                table[undefendedIndex].defend = defendCard;

                // Usu≈Ñ kartƒô z rƒôki
                playerHand.splice(window.selectedCard, 1);

                // Sprawd≈∫ czy wszystkie karty sƒÖ obronione
                const allDefended = table.every(pair => pair.defend !== null);

                // Aktualizuj pok√≥j
                const updates = {
                    table: table,
                    [`players/${window.currentUser}/hand`]: playerHand
                };

                if (allDefended) {
                    updates.turnPhase = 'attack';
                }

                update(roomRef, updates);
                window.selectedCard = null;
            });
        };

        // We≈∫ karty
        window.takeCards = function() {
            const roomRef = ref(database, `rooms/${window.currentRoom}`);
            get(roomRef).then((snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                const playerHand = room.players[window.currentUser].hand;
                const table = room.table || [];

                // Dodaj wszystkie karty ze sto≈Çu do rƒôki
                table.forEach(pair => {
                    if (pair.attack) playerHand.push(pair.attack);
                    if (pair.defend) playerHand.push(pair.defend);
                });

                // Wyczy≈õƒá st√≥≈Ç i zmie≈Ñ turƒô
                update(roomRef, {
                    table: [],
                    [`players/${window.currentUser}/hand`]: playerHand,
                    currentAttacker: room.currentDefender,
                    currentDefender: room.currentAttacker,
                    turnPhase: 'attack'
                });
            });
        };

        // Pas
        window.pass = function() {
            const roomRef = ref(database, `rooms/${window.currentRoom}`);
            get(roomRef).then((snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                // Wyczy≈õƒá st√≥≈Ç i zmie≈Ñ turƒô
                update(roomRef, {
                    table: [],
                    currentAttacker: room.currentDefender,
                    currentDefender: room.currentAttacker,
                    turnPhase: 'attack'
                });

                // Dobierz karty (je≈õli sƒÖ w talii)
                drawCards(room);
            });
        };

        // Dobieranie kart
        function drawCards(room) {
            const roomRef = ref(database, `rooms/${room.currentRoom || window.currentRoom}`);
            const players = Object.keys(room.players);

            players.forEach(player => {
                const hand = room.players[player].hand;
                while (hand.length < 6 && room.deck.length > 0) {
                    hand.push(room.deck.shift());
                }
                update(ref(database, `rooms/${window.currentRoom}/players/${player}`), { hand: hand });
            });

            // Zaktualizuj taliƒô
            update(roomRef, { deck: room.deck });
        }

        // Eksportuj funkcje do window
        window.database = database;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.update = update;
        window.remove = remove;
        window.onValue = onValue;
    </script>
</body>
</html>